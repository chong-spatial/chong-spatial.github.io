<!DOCTYPE html>
<meta charset="utf-8">
<title>Voronoi used as service area</title>
<style>


.desc {
    list-style: decimal-leading-zero;
    font-size: 1.4em;
    margin: 0 0 0 2em;
}

.polygon{
  fill: none;
  stroke: #000;
}

.voronoi{
  fill: none;
  stroke: #000;
}

.market {
  fill: green;
}

.voronoi :first-child {
  fill: #f00;
}

</style>
<body>
  <div class = "desc">
    <div>The farmer markets data is from http://www.arcgis.com/home/item.html?id=11c83c0b419a41f4a9b7aa4e86e80806</div>
    <div>Voronoi Farmer Markets has advantages:
      <ol>
        <li>
        Each region is closer to a particular farmer market than any other. </li>
        <li>There are two farmer markets on opposite sides of the line that are at exactly the same distance from that line. </li>
        <li>Assumed that every farmer market has an equal influence. This isnâ€™t true as farmer markets are of difference sizes and have different facilities. It would be possible to color the corresponding voronoi cells or use a weighted Voronoi diagram.</li>

        <li>It describes the spatial relationship between farmer markets.</li>
        <li>The low density of farmer markets in the inland area, in contrast to the surrounding towns and cities of SF, LA, and SD. </li>
        <li>Can be used to find the nearest farmer market. </li>
        <li>Can be used to create a new farmer market (service area).</li>
    </ol>
    </div>
  </div>
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="http://d3js.org/topojson.v1.min.js"></script>
<script src="http://d3js.org/queue.v1.min.js"></script>
<script>

var width = 960,
    height = 600;

var vorSeeds, clipPoly;

var projection = d3.geo.albers()
    .rotate([120, 0])
    .center([0, 37.7])
    .scale(2700);

var zoom = d3.behavior.zoom()
    .scaleExtent([1, 8])
    .on("zoom", zoomed);


var path = d3.geo.path()
    .projection(projection)
    .pointRadius(1.5);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height)

    .on('mousemove', update)

var g = svg.append('g');

var state_g = g.append("g").attr('class', 'polygon'),    
    voronoi_g = g.append("g").attr('class', 'voronoi'),
    market_g = g.append("g");

/*
// mouse posision is not precise when zooming
svg
    .call(zoom)
    .call(zoom.event);
*/
queue()
  .defer(d3.json, "data/california.json")
  .defer(d3.json, 'data/ca_farmer_market.geojson')
  .await(makeVornoiMap);

function zoomed() {
  g.attr("transform", "translate(" + d3.event.translate + ")scale(" + d3.event.scale + ")");
}

function makeVornoiMap(error, ca, market){
  var coordinates0 = ca.coordinates[0].map(projection),
      d0 = "M" + coordinates0.join("L") + "Z";
      

  var multipleMarketPoints = market.features.map(function(m){ return m.geometry.coordinates});

  var caPath = state_g.append("path").attr("d", d0);

  
  /*
    var markets = svg.selectAll("circle")
      .data(market.features).enter()
      .append("circle")
      .attr("cx", function (d) { return projection(d.geometry.coordinates)[0]; })
      .attr("cy", function (d) { return projection(d.geometry.coordinates)[1]; })
      .attr("r", "4px")
      .attr("fill", "red")
  */

  var voronoiFunc = d3.geom.voronoi();
  vorSeeds = multipleMarketPoints.map(projection);
  var vorCells = voronoiFunc(vorSeeds);

  clipPoly = d3.geom.polygon(coordinates0);
      
  var vorPathData = vorCells.map(function(d){ return d3.geom.polygon(d).clip(clipPoly.slice()) });
           
  var vorPath = voronoi_g.selectAll("path")
      .data(vorPathData).enter()
      .append('path')      
      .attr("d", function(d) { return !d ? 'MZ' : "M" + d.join("L") + "Z";
        /*
        return "M" + d
            .filter(function(d) { return d != null; })
            .map(function(d) { return d.join("L"); })
            .join("ZM") + "Z";
        */
      });



  var markets = market_g.append("path")
      .datum({type: "MultiPoint", coordinates: multipleMarketPoints})
      .attr("class", "market")
      .attr("d", path);

}

function update() {
   vorSeeds[0] = d3.mouse(this);

      
  var newVorPathData = d3.geom.voronoi(vorSeeds).map(function(d){ return d3.geom.polygon(d).clip(clipPoly.slice()) });
   

   voronoi_g.selectAll("path")
       .data(newVorPathData.map(function(d) { return !d ? 'MZ' : "M" + d.join("L") + "Z"; }))
       .filter(function(d) { return this.getAttribute("d") != d; })
       .attr("d", function(d) { return d; });
 }

</script>

<!-- Start of StatCounter Code for Default Guide -->
    <script type="text/javascript">
    var sc_project=10227952; 
    var sc_invisible=1; 
    var sc_security="19025bec"; 
    var sc_https=1; 
    var scJsHost = (("https:" == document.location.protocol) ?
    "https://secure." : "http://www.");
    document.write("<sc"+"ript type='text/javascript' async src='" + scJsHost+ 
    "statcounter.com/counter/counter_xhtml.js'></"+"script>"); 
    </script> 
    <noscript><div class='statcounter'><a class='statcounter' href='http://statcounter.com/free-web-stats/' title='web stats'><img alt='web stats' class='statcounter' src='http://c.statcounter.com/10227952/0/19025bec/1/'/></a></div></noscript> 
<!-- End of StatCounter Code for Default Guide -->
</body>
</html>