angular.module("SFMuniVIS").controller("MainCtrl",["$scope","$http","$timeout","constants","sharedService",function(b,r,t,n,c){function p(){var g=(new Date).getTime()-6E4;d3.xml(n.feedURL.vehicleURL+g,function(h,a){for(var e=a.documentElement.getElementsByTagName("vehicle"),d=0;d<e.length;d++){var f=e[d],l=f.getAttribute("id"),k=f.getAttribute("routeTag"),m=[+f.getAttribute("lon"),+f.getAttribute("lat")],q=+f.getAttribute("secsSinceReport"),f=+f.getAttribute("speedKmHr");null==b.vehicleMap[l]?(k=
{id:l,tag:k,lonLat:m,reportDelay:q,speed:f,moveAngle:null,history:[{t:g,reportDelay:q,speed:f,lonLat:m}],color:c.routeColorScale(isNaN(k.charAt(0))?"A-Z":k.charAt(0)),rectWidth:n.minSymbolSize,rectHeight:n.minSymbolSize},b.vehicleMap[l]=k,b.allTrackedVehicles.push(k),1E3<b.allTrackedVehicles.length&&(m=b.allTrackedVehicles.shift(),delete b.vehicleMap[m.id])):(k=b.vehicleMap[l],l=Math.atan2(b.projection(m)[1]-b.projection(k.lonLat)[1],b.projection(m)[0]-b.projection(k.lonLat)[0]),l=360*(0<l?l:2*Math.PI+
l)/(2*Math.PI),k.history.unshift({t:g,reportDelay:q,speed:f,lonLat:m}),30<k.history.length&&k.history.pop(),k.lonLat=m,k.reportDelay=q,k.speed=f,k.moveAngle=l)}u();v();setTimeout(p,6E3)})}function u(){var g=d3.select(".map svg g").select(".vehicles").selectAll(".vehicle").data(b.allTrackedVehicles,function(a){return a.id}),h=g.enter().append("g").attr("class",function(a){return"vehicle t"+a.tag}).attr("transform",function(a){return"translate("+(b.projection(a.lonLat)[0]-a.rectWidth/2)+","+(b.projection(a.lonLat)[1]-
a.rectHeight/2)+")"}).on("click",function(a){c.treevis().toggleLeaf(a.tag);c.treevis().highlightLeaf(a.tag);d3.select(this).select(".symbol").classed("dead")&&(c.timelinevis().inspectedVehicle(a),d3.selectAll(".inspectUl li").classed("ui-selected",function(b){return b.id==a.id}))});h.append("rect").attr("width",function(a){return a.rectWidth}).attr("height",function(a){return a.rectHeight}).attr("class","symbol").style("fill",function(a){return a.color});h.append("text").attr("text-anchor","start").attr("y",
function(a){return a.rectHeight-2}).attr("class","label").text(function(a){return a.tag}).style("display","none");h.append("path").attr("d",function(a){return"M"+a.rectWidth+",0 L"+(a.rectWidth+a.rectWidth/2)+","+a.rectHeight/2+" L"+a.rectWidth+","+a.rectHeight}).attr("class","arrow").style("stroke",function(a){return a.color});g.transition().duration(6E3).attr("transform",function(a){return"translate("+(b.projection(a.lonLat)[0]-a.rectWidth/2)+","+(b.projection(a.lonLat)[1]-a.rectHeight/2)+")"});
g.select(".arrow").attr("d",function(a){return"M"+a.rectWidth+",0 L"+(a.rectWidth+a.rectWidth/2)+","+a.rectHeight/2+" L"+a.rectWidth+","+a.rectHeight}).attr("transform",function(a){return a.moveAngle?"rotate("+a.moveAngle+" "+a.rectWidth/2+" "+a.rectHeight/2+")":""}).style("display",function(a){return a.moveAngle?360==a.moveAngle?"none":null:"none"});g.select(".symbol").classed("dead",function(a){return 30<=w(a.history.map(function(a){return a.lonLat}))?!0:!1});g.exit().remove();if(g=c.shownRoutes())d3.select(".map").selectAll(".vehicle").style("display",
"none"),g.forEach(function(a){d3.select(".map").select(".vehicles").selectAll(".t"+a).style("display","block")});b.adjustLabel()}function v(){var g=!0,h=[],a=c.timelinevis().inspectedVehicle();d3.select(".map").select(".vehicles").selectAll(".dead").each(function(d){a&&d.id==a.id&&(g=!1);h.push(d)});if(h.length){d3.select("#delaySdColorScale").style("display","block");g&&c.timelinevis().inspectedVehicle(null);var e=h.map(function(a){return d3.deviation(a.history.map(function(a){return a.reportDelay}))}),
d=d3.min(e),f=d3.max(e),e=d3.deviation(e);c.delayDeviationColorScale.domain([d,(d+f)/2+1*e>f?(d+f)/2:(d+f)/2+1*e,f]);d=+d3.select("#delaySdColorScale svg").attr("width");d=d3.scale.linear().range([0,d]).domain(c.delayDeviationColorScale.domain());d=d3.svg.axis().scale(d).orient("bottom");d3.select("#delaySdColorScale .axis").call(d);h.sort(function(a,d){return a.tag<d.tag?-1:a.tag>d.tag?1:0});d=d3.select(".inspectUl ul").selectAll(".vehicle").data(h,function(a){return a.tag+"_"+a.id});d.exit().remove();
f=d.enter().append("li").attr("class","vehicle").on("click",function(a){c.treevis().toggleLeaf(a.tag);c.treevis().highlightLeaf(a.tag);c.timelinevis().inspectedVehicle(a);b.centerZoomCtrl(a.lonLat);d3.selectAll(".inspectUl li").classed("ui-selected",!1);d3.select(this).classed("ui-selected",!0)});d.order();f.append("span").attr("class","symbol").style("background",function(a){return a.color}).html(function(a){return a.tag});f.append("span").attr("class","label").style("background",function(a){return c.delayDeviationColorScale(d3.deviation(a.history.map(function(a){return a.reportDelay})))}).html(function(a){return"ID:"+
a.id})}else g&&c.timelinevis().inspectedVehicle(null),d3.select("#delaySdColorScale").style("display","none")}function w(b){var c=[],a,e;for(a=0;a<b.length;a++)if(e=c.length,0===e||c[e-1][0]==b[a][0]&&c[e-1][1]==b[a][1])c[e]=b[a];else break;return c.length}b.streets=[];b.routeMap={};b.vehicleMap={};b.allTrackedVehicles=[];b.treedata=null;r.get("data/sfmaps/streets.json").success(function(c){b.streets=c.features});(function(){d3.xml(n.feedURL.routeURL,function(g,h){if(g)throw g;var a=[].map.call(h.querySelectorAll("route"),
function(a){return{tag:a.getAttribute("tag"),title:a.getAttribute("title"),name:a.getAttribute("tag"),type:"route",colorDomain:isNaN(a.getAttribute("tag").charAt(0))?"A-Z":a.getAttribute("tag").charAt(0)}});a.forEach(function(a){d3.xml(n.feedURL.routeConfigURL+a.tag+"&terse",function(d,c){var f=c.documentElement.getElementsByTagName("stop");b.routeMap[a.tag]={title:a.title,colorDomain:a.colorDomain};var e=[];b.routeMap[a.tag].stop=e;for(var g=0;g<f.length;g++){var h=f[g],l=h.getAttribute("stopId"),
n=h.getAttribute("tag"),p=[+h.getAttribute("lon"),+h.getAttribute("lat")],h=h.getAttribute("title");e.push({stopId:l,stopTag:n,stopTitle:h,stopLonLat:p})}})});var e={};a.forEach(function(a){var b=a.tag.charAt(0).toLowerCase(),b=isNaN(b)?"A-Z":b;e.hasOwnProperty(b)?e[b].push(a):e[b]=[a]});a={id:"root",type:"root",name:"Routes",children:[]};a.children=Object.keys(e).map(function(a){return{type:"group",name:a,children:e[a]}});c.routeColorScale.domain(a.children.map(function(a){return a.name}));a.children.forEach(function(a){a.color=
c.routeColorScale(a.name);a.children.forEach(function(a){a.color=c.routeColorScale(a.colorDomain)})});b.treedata=a})})();d3.select("#colorLgSpStart").attr("stop-color",c.delayDeviationColorScale.range()[0]);d3.select("#colorLgSpMiddle").attr("stop-color",c.delayDeviationColorScale.range()[1]);d3.select("#colorLgSpEnd").attr("stop-color",c.delayDeviationColorScale.range()[2]);t(function(){p()},500)}]);