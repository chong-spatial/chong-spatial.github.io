<!DOCTYPE html>
<head>
  <title>Three.js+Mapbox animation</title>
  <script src="dist/threebox.js" type="text/javascript"></script>
  <link href="dist/threebox.css" rel="stylesheet" />
  <script src="config.js"></script>
  <link
    href="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.css"
    rel="stylesheet"
  />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.2.0/mapbox-gl.js"></script>
  <!-- Place your kit's code here -->
  <script src="css/fontawesome.js"></script>
  <link href="css/free.min.css" rel="stylesheet" />
  <link href="css/free-v4-font-face-min.css" rel="stylesheet" />
  <link href="css/free-v4-shims.min.css" rel="stylesheet" />

  <style>
    body,
    html {
      width: 100%;
      height: 100%;
      margin: 0;
      background: black;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    .top-right-tools {
      display: flex;
      right: 40px;
      z-index: 10;
    }

    .tools-i.mapboxgl-ctrl {
      margin: 10px 20px 0 0;
      display: inline-flex;
    }

    /*these 3 clases will provide mapbox-like style for labels*/
    .toolTip {
      border: 0.5px black solid;
      display: inline-block;
      background: white;
      padding: 1px 6px;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      font-size: 11px !important;
    }

    .marker {
      max-width: 240px;
      display: flex;
      margin-bottom: 5em;
      text-align: center;
    }

    .mapboxgl-popup-tip {
      margin-top: -1px;
    }
  </style>
</head>
<body>
  <div id="map" class="map">
    <div
      class="mapboxgl-ctrl-top-right top-right-tools"
      aria-label="Map Tools Control"
    ></div>
  </div>

  <script type="module">
    mapboxgl.accessToken = config.accessToken;

    var origin = [-77.03361757, 38.89550908];
    var destination, line;
    var truck;

    var map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/outdoors-v11",
      center: [-77.03010902740367, 38.89374710790031],
      zoom: 16,
      pitch: 60,
      antialias: true,
      bearing: 0,
    });
    map.addControl(new mapboxgl.NavigationControl());

    let stats;
    import Stats from "https://threejs.org/examples/jsm/libs/stats.module.js";
    function animate() {
      requestAnimationFrame(animate);
      stats.update();
    }

    map
      .on("style.load", function () {
        // stats
        stats = new Stats();
        map.getContainer().appendChild(stats.dom);
        animate();

        map.addLayer({
          id: "custom_layer",
          type: "custom",
          renderingMode: "3d",
          onAdd: function (map, mbxContext) {
            window.tb = new Threebox(map, mbxContext, {
              defaultLights: true,
              enableSelectingFeatures: true,
              enableSelectingObjects: true,
              enableDraggingObjects: true,
              enableRotatingObjects: true,
              enableTooltips: true,
            });

            // Royalty Free License: Vehicles by https://www.cgtrader.com/antonmoek
            // from https://www.cgtrader.com/free-3d-models/car/concept/cartoon-low-poly-city-cars-pack
            var options = {
              obj: "models/truck.glb",
              type: "gltf",
              scale: 100,
              units: "meters",
              rotation: { x: 90, y: 90, z: 0 },
              anchor: "top",
            };

            tb.loadObj(options, function (model) {
              truck = model.setCoords(origin);

              // Listening to the events
              truck.addEventListener("SelectedChange", onSelectedChange, false);

              tb.add(truck);
            });
          },

          render: function (gl, matrix) {
            tb.update();
          },
        });
      })
      .on("load", function (e) {
        travelPath();
      })
      .on("click", (e) => {
        if (truck?.isPlaying) {
          truck.stop();
          truck.isPlaying = false;
        } else {
          travelPath();
        }
      });

    function travelPath() {
      let duration = 20000;
      // extract path geometry from callback geojson, and set duration of travel
      var options = {
        animation: 1,
        // path: data.routes[0].geometry.coordinates,
        path: [
          [-77.03345029096506, 38.89550283078424],
          [-77.03329635660792, 38.89551535609911],
          [-77.03199401325315, 38.895551254148955],
          [-77.03077495037364, 38.89554018162417],
          [-77.02964818202621, 38.89543110134477],
          [-77.02812924789495, 38.89501306081527],
          [-77.02813480097348, 38.89407707524035],
          [-77.02813237171861, 38.89286812384259],
          [-77.02816554551273, 38.89209893738385],
          [-77.0319598703765, 38.892105960859226],
          [-77.03365281611205, 38.89213420770872],
          [-77.03364342623212, 38.89530979063653],
        ],
        duration: duration,
      };

      truck.isPlaying = true;
      truck.playAnimation(options);

      // set up geometry for a line to be added to map, lofting it up a bit for *style*
      var lineGeometry = options.path.map(function (coordinate) {
        return coordinate.concat([15]);
      });

      // create and add line object
      line = tb.line({
        geometry: lineGeometry,
        width: 8,
        color: "steelblue",
      });

      tb.add(line);

      // start the truck animation with above options, and remove the line when animation ends
      truck.followPath(options, function () {
        tb.remove(line);
        truck.isPlaying = false;
      });
    }

    let selectedObject;

    //actions to execute onSelectedChange
    function onSelectedChange(e) {
      let selected = e.detail.selected;
      if (selected) {
        selectedObject = e.detail;
      }
      tb.update();
      map.repaint = true;
    }
  </script>
  <!-- Default Statcounter code for Personal page
https://chongzhang-vis.github.io/ -->
  <script type="text/javascript">
    var sc_project = 10227952;
    var sc_invisible = 1;
    var sc_security = "19025bec";
  </script>
  <script
    type="text/javascript"
    src="https://www.statcounter.com/counter/counter.js"
    async
  ></script>
  <noscript
    ><div class="statcounter">
      <a title="Web Analytics" href="https://statcounter.com/" target="_blank"
        ><img
          class="statcounter"
          src="https://c.statcounter.com/10227952/0/19025bec/1/"
          alt="Web Analytics"
          referrerpolicy="no-referrer-when-downgrade"
      /></a></div
  ></noscript>
  <!-- End of Statcounter Code -->
</body>
